<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Đơn Nhập Kho</title>
    <style>
        body {
            margin: 0;
            font-family: Segoe UI;
            background: #f1f5f9;
        }

        .wrapper {
            padding: 40px;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,.08);
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-btn {
            background: #64748b;
            color: white;
        }

        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        input, select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .add-btn {
            background: #2563eb;
            color: white;
        }

        .submit-btn {
            background: #16a34a;
            color: white;
            margin-top: 20px;
        }

        .remove-btn {
            background: #ef4444;
            color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
            text-align: center;
        }

        th {
            background: #f8fafc;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.5);
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            width: 600px;
            max-height: 500px;
            overflow: auto;
            padding: 25px;
            border-radius: 12px;
        }

        .modal-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

            .modal-item:hover {
                background: #f1f5f9;
            }
    </style>
</head>
<body>

    <div class="wrapper">
        <div class="card">

            <div class="top-bar">
                <h2>📥 Tạo Đơn Nhập Kho</h2>
                <button class="back-btn"
                        onclick="location.href='home.html'">
                    ⬅ Back
                </button>
            </div>

            <div class="form-row">
                <input id="desc" placeholder="Mô tả đơn nhập">
                <select id="warehouseTo"></select>
            </div>

            <button class="add-btn" onclick="openModal()">+ Thêm sản phẩm</button>

            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tên</th>
                        <th>Số lượng</th>
                        <th>X</th>
                    </tr>
                </thead>
                <tbody id="bodyTable"></tbody>
            </table>

            <button class="submit-btn" onclick="submitInbound()">Lưu đơn nhập</button>

        </div>
    </div>

    <!-- MODAL -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <h3>Danh sách sản phẩm</h3>
            <div id="productList"></div>
            <br>
            <button onclick="closeModal()">Đóng</button>
        </div>
    </div>

    <script>
        const BASE = "https://localhost:7297/api/storekeeper";
        let products = [];

        /* LOAD WAREHOUSE */
        async function loadWarehouses() {
            const res = await fetch(BASE + "/warehouses", { credentials: "include" });
            const json = await res.json();
            if (!json.success) return alert("Không load được kho");

            const select = document.getElementById("warehouseTo");
            json.data.forEach(w => {
                select.innerHTML += `<option value="${w.id}">${w.name}</option>`;
            });
        }

        /* LOAD ITEM-DEFS */
        async function loadProducts() {
            const res = await fetch(BASE + "/item-defs", { credentials: "include" });
            const json = await res.json();
            if (!json.success) return alert("Không load được sản phẩm");
            products = json.data;
        }

        /* MODAL */
        function openModal() {
            renderProductList();
            document.getElementById("productModal").style.display = "flex";
        }
        function closeModal() {
            document.getElementById("productModal").style.display = "none";
        }

        function renderProductList() {
            const list = document.getElementById("productList");
            list.innerHTML = "";
            products.forEach(p => {
                list.innerHTML += `
            <div class="modal-item"
            onclick="addItem(${p.id}, '${p.metadata.name.replace(/'/g, "")}')">
            <b>${p.metadata.name}</b><br>
            ${p.metadata.desc || ""}<br>
            Giá: ${p.unit_price} / ${p.unit}
            </div>`;
            });
        }

        /* ADD ITEM */
        function addItem(id, name) {
            let existed = false;
            document.querySelectorAll("#bodyTable tr").forEach(r => {
                if (parseInt(r.cells[0].innerText) === id) existed = true;
            });
            if (existed) return alert("Sản phẩm đã tồn tại!");

            const row = `
        <tr>
            <td>${id}</td>
            <td>${name}</td>
            <td><input type="number" value="1" min="1"></td>
            <td><button class="remove-btn" onclick="removeRow(this)">X</button></td>
        </tr>`;
            document.getElementById("bodyTable").insertAdjacentHTML("beforeend", row);
            closeModal();
        }
        function removeRow(btn) { btn.closest("tr").remove(); }

        /* SUBMIT */
        async function submitInbound() {
            const rows = document.querySelectorAll("#bodyTable tr");
            if (rows.length === 0) return alert("Chưa có sản phẩm");

            const items = [];
            rows.forEach(r => {
                items.push({
                    def_id: parseInt(r.cells[0].innerText),
                    quantity: parseInt(r.cells[2].querySelector("input").value)
                });
            });

            const payload = {
                items: items,
                desc: document.getElementById("desc").value,
                warehouse_from_id: null,
                warehouse_to_id: parseInt(document.getElementById("warehouseTo").value)
            };

            const res = await fetch(BASE + "/create-inbound", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify(payload)
            });

            const json = await res.json();
            if (!json.success) {
                console.log(json);
                return alert("Tạo đơn thất bại");
            }

            alert("Tạo đơn thành công!");
            document.getElementById("desc").value = "";
            document.getElementById("bodyTable").innerHTML = "";
            location.reload;
        }

        loadWarehouses();
        loadProducts();
    </script>

</body>
</html>