<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Phiếu Xuất Kho</title>

    <style>
        body {
            font-family: Segoe UI;
            background: #eef2f7;
            padding: 30px;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 14px;
            box-shadow: 0 8px 25px rgba(0,0,0,.08);
        }

        .top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .back {
            background: #64748b;
            color: white;
        }

        .add {
            background: #2563eb;
            color: white;
            margin-top: 15px;
        }

        .save {
            background: #ef4444;
            color: white;
            margin-top: 20px;
        }

        .remove {
            background: #ef4444;
            color: white;
        }

        input, select {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            width: 100%;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #e5e7eb;
            padding: 8px;
            text-align: center;
        }

        th {
            background: #f1f5f9;
        }

        .total {
            text-align: right;
            font-weight: bold;
            margin-top: 10px;
            font-size: 16px;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.4);
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-box {
            background: white;
            width: 600px;
            max-height: 500px;
            overflow: auto;
            padding: 20px;
            border-radius: 12px;
        }

        .modal-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

            .modal-item:hover {
                background: #f1f5f9;
            }
    </style>
</head>

<body>

    <div class="card">

        <div class="top">
            <h2>📤 PHIẾU XUẤT KHO</h2>
            <button class="back" onclick="location.href='home.html'">⬅ Back</button>
        </div>

        <br>

        <label>Mô tả:</label>
        <input id="desc" placeholder="Nhập mô tả đơn">

        <br><br>

        <div class="row">
            <div>
                <label>Chọn Kho:</label>
                <select id="warehouse" onchange="loadBinsByWarehouse()"></select>
            </div>

            <div>
                <label>Chọn Bin xuất:</label>
                <select id="binFrom"></select>
            </div>
        </div>

        <button class="add" onclick="openModal()">+ Thêm sản phẩm</button>

        <table>
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Tên hàng</th>
                    <th>Đơn vị</th>
                    <th>Số lượng</th>
                    <th>Đơn giá</th>
                    <th>Thành tiền</th>
                    <th>X</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <div class="total">
            Tổng tiền: <span id="totalMoney">0</span>
        </div>

        <button class="save" onclick="submitOutbound()">Lưu Phiếu</button>

    </div>

    <!-- MODAL -->
    <div id="modal" class="modal">
        <div class="modal-box">
            <h3>Danh sách sản phẩm</h3>
            <div id="productList"></div>
            <br>
            <button onclick="closeModal()">Đóng</button>
        </div>
    </div>

    <script>

        const BASE = "https://localhost:7297/api/storekeeper";
        let components = [];
        let count = 0;

        /* LOAD WAREHOUSE */
        async function loadWarehouses() {

            const res = await fetch(BASE + "/warehouses", { credentials: "include" });
            if (!res.ok) { console.log(await res.text()); return alert("API warehouse lỗi"); }

            const json = await res.json();
            if (!json.success) return alert("Không load được warehouse");

            const select = document.getElementById("warehouse");
            select.innerHTML = "";

            json.data.forEach(w => {
                const id = w.warehouseId ?? w.id;
                const name = w.warehouseName ?? w.name ?? id;
                select.innerHTML += `<option value="${id}">${name}</option>`;
            });

            loadBinsByWarehouse();
        }

        /* LOAD BIN */
        async function loadBinsByWarehouse() {

            const warehouseId = document.getElementById("warehouse").value;
            if (!warehouseId) return;

            const res = await fetch(BASE + "/bins/by-warehouse/" + warehouseId,
                { credentials: "include" });

            if (!res.ok) { console.log(await res.text()); return alert("API bins lỗi"); }

            const json = await res.json();
            if (!json.success) return alert("Không load được bin");

            const binSelect = document.getElementById("binFrom");
            binSelect.innerHTML = "";

            json.data.forEach(b => {
                const id = b.binId ?? b.id;
                const code = b.locationInWarehouse ?? b.binCode ?? id;
                binSelect.innerHTML += `<option value="${id}">${code}</option>`;
            });
        }

        /* LOAD COMPONENT */
        async function loadComponents() {
            const res = await fetch(BASE + "/components", { credentials: "include" });
            const json = await res.json();
            if (!json.success) return alert("Không load được sản phẩm");
            components = json.data;
        }

        /* MODAL */
        function openModal() { renderList(); document.getElementById("modal").style.display = "flex"; }
        function closeModal() { document.getElementById("modal").style.display = "none"; }

        /* RENDER LIST */
        function renderList() {

            const list = document.getElementById("productList");
            list.innerHTML = "";

            components.forEach(c => {

                const id = c.componentId ?? c.id;
                const name = c.name ?? c.metadata?.name ?? "No name";
                const unit = c.unit ?? "N/A";
                const price = c.unitPrice ?? 0;

                list.innerHTML += `
<div class="modal-item"
onclick="addItem(${id},'${name}',${price},'${unit}')">
<b>${name}</b><br>
Đơn vị: ${unit}<br>
Giá: ${price}
</div>`;
            });
        }

        /* ADD ROW */
        function addItem(id, name, price, unit) {

            count++;

            const row = `
<tr>
<td>${count}</td>
<td data-id="${id}">${name}</td>
<td>${unit}</td>
<td><input type="number" value="1" min="1" onchange="calc()"></td>
<td><input type="number" value="${price}" onchange="calc()"></td>
<td class="money">${price}</td>
<td><button class="remove" onclick="removeRow(this)">X</button></td>
</tr>`;

            document.getElementById("tableBody").insertAdjacentHTML("beforeend", row);
            closeModal();
            calc();
        }

        function removeRow(btn) {
            btn.closest("tr").remove();
            calc();
        }

        /* CALC */
        function calc() {

            let total = 0;

            document.querySelectorAll("#tableBody tr").forEach(r => {

                const qty = parseFloat(r.cells[3].querySelector("input").value) || 0;
                const price = parseFloat(r.cells[4].querySelector("input").value) || 0;

                const money = qty * price;
                r.querySelector(".money").innerText = money;
                total += money;
            });

            document.getElementById("totalMoney").innerText = total;
        }

        /* SUBMIT */
        async function submitOutbound() {

            const rows = document.querySelectorAll("#tableBody tr");
            if (rows.length === 0) return alert("Chưa có sản phẩm");

            const payload = {
                desc: document.getElementById("desc").value,
                bin_from_id: parseInt(document.getElementById("binFrom").value),
                bin_to_id: null,
                components: []
            };

            rows.forEach(r => {
                payload.components.push({
                    component_id: parseInt(r.cells[1].dataset.id),
                    quantity: parseInt(r.cells[3].querySelector("input").value),
                    unit_price: parseFloat(r.cells[4].querySelector("input").value)
                });
            });

            console.log("SEND:", payload);

            const res = await fetch(BASE + "/create-outbound", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify(payload)
            });

            const json = await res.json();
            console.log("RESPONSE:", json);

            if (!json.success) return alert("Tạo thất bại: " + json.msg);

            alert("Tạo phiếu xuất thành công!");
            location.reload();
        }

        /* INIT */
        loadWarehouses();
        loadComponents();

    </script>

</body>
</html>