<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Admin | User Management</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="layout">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <h2 class="logo">ECWMS</h2>
        <ul>
            <li class="active">User Management</li>
            <li>System Configuration</li>
            <li id="logoutBtn">Logout</li>
        </ul>
    </aside>

    <!-- MAIN -->
    <main class="content">

        <!-- HEADER -->
        <div class="header">
            <h1>User Management</h1>
            <button class="btn-primary" onclick="loadUsers()">Refresh</button>
        </div>

        <!-- FILTER -->
        <div class="filter-bar">
            <input type="text" id="searchInput" placeholder="Search by username">
            <button class="btn-secondary" id="searchBtn">Search</button>
        </div>

        <!-- TABLE -->
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="userTableBody"></tbody>
        </table>

    </main>
</div>

<script>

const BASE_URL = "https://localhost:7297/api";

/* ================= API CALL ================= */
async function apiRequest(endpoint, method = "GET", body = null) {

    const options = {
        method: method,
        headers: { "Content-Type": "application/json" },
        credentials: "include"   // VERY IMPORTANT (cookie auth)
    };

    if (body) options.body = JSON.stringify(body);

    const response = await fetch(BASE_URL + endpoint, options);

    if (response.status === 401) {
        alert("You are not logged in!");
        window.location.href = "login.html";
        return null;
    }

    return await response.json();
}

/* ================= LOAD USERS ================= */
async function loadUsers() {

    const result = await apiRequest("/admin/users");

    if (!result || !result.success) {
        alert("Cannot load users");
        return;
    }

    renderUsers(result.data);
}

/* ================= RENDER TABLE ================= */
function renderUsers(users) {

    const tbody = document.getElementById("userTableBody");
    tbody.innerHTML = "";

    if (!users || users.length === 0) {
        tbody.innerHTML = "<tr><td colspan='4'>No users found</td></tr>";
        return;
    }

    users.forEach(user => {

        const roles = user.roles
            ? user.roles.map(r => r.roleName).join(", ")
            : "";

        const row = `
            <tr>
                <td>${user.userId}</td>
                <td>${user.username}</td>
                <td>${roles}</td>
                <td>
                    <button class="action-btn" onclick="deleteUser(${user.userId})">
                        Delete
                    </button>
                </td>
            </tr>
        `;

        tbody.innerHTML += row;
    });
}

/* ================= DELETE USER ================= */
async function deleteUser(id) {

    if (!confirm("Delete this user?")) return;

    const result = await apiRequest(`/admin/delete-account/${id}`, "DELETE");

    if (result && result.success) {
        alert("Deleted successfully");
        loadUsers();
    } else {
        alert(result?.message || "Delete failed");
    }
}

/* ================= SEARCH ================= */
async function searchUsers() {

    const query = document.getElementById("searchInput").value;

    if (!query) {
        loadUsers();
        return;
    }

    const result = await apiRequest(`/admin/search-users?query=${query}`);

    if (result && result.success) {
        renderUsers(result.data);
    } else {
        alert("Search failed");
    }
}

/* ================= LOGOUT ================= */
async function logout() {
    await apiRequest("/auth/logout", "POST");
    window.location.href = "login.html";
}

/* ================= EVENTS ================= */
document.getElementById("searchBtn").addEventListener("click", searchUsers);
document.getElementById("logoutBtn").addEventListener("click", logout);
document.addEventListener("DOMContentLoaded", loadUsers);

</script>

</body>
</html>
