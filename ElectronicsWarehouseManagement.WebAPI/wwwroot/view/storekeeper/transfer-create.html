<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Tạo Đơn Chuyển Kho</title>
    <style>
        body {
            margin: 0;
            font-family: Segoe UI;
            background: #f1f5f9;
        }

        .wrapper {
            padding: 40px;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,.08);
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        input, select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .add-btn {
            background: #2563eb;
            color: white;
        }

        .submit-btn {
            background: #7c3aed;
            color: white;
            margin-top: 20px;
        }

        .back-btn {
            background: #64748b;
            color: white;
        }

        .remove-btn {
            background: #ef4444;
            color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
            text-align: center;
        }

        th {
            background: #f8fafc;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.5);
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            width: 600px;
            max-height: 500px;
            overflow: auto;
            padding: 25px;
            border-radius: 12px;
        }

        .modal-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

            .modal-item:hover {
                background: #f1f5f9;
            }
    </style>
</head>
<body>

    <div class="wrapper">
        <div class="card">

            <div class="top-bar">
                <h2>🔄 Tạo Đơn Chuyển Kho</h2>
                <button class="back-btn" onclick="location.href='home.html'">⬅ Back</button>
            </div>

            <div class="form-row">
                <input id="desc" placeholder="Mô tả đơn chuyển">
                <select id="warehouseFrom"></select>
                <select id="warehouseTo"></select>
            </div>

            <button class="add-btn" onclick="openModal()">+ Thêm sản phẩm</button>

            <table>
                <thead>
                    <tr><th>ID</th><th>Tên</th><th>Số lượng</th><th>X</th></tr>
                </thead>
                <tbody id="bodyTable"></tbody>
            </table>

            <button class="submit-btn" onclick="submitTransfer()">Tạo đơn chuyển</button>

        </div>
    </div>

    <div id="productModal" class="modal">
        <div class="modal-content">
            <h3>Danh sách sản phẩm</h3>
            <div id="productList"></div>
            <br>
            <button onclick="closeModal()">Đóng</button>
        </div>
    </div>

    <script>
        const BASE = "https://localhost:7297/api/storekeeper";
        let products = [];

        async function loadWarehouses() {
            const res = await fetch(BASE + "/warehouses", { credentials: "include" });
            const json = await res.json();
            if (!json.success) return;
            json.data.forEach(w => {
                warehouseFrom.innerHTML += `<option value="${w.id}">${w.name}</option>`;
                warehouseTo.innerHTML += `<option value="${w.id}">${w.name}</option>`;
            });
        }

        async function loadProducts() {
            const res = await fetch(BASE + "/item-defs", { credentials: "include" });
            const json = await res.json();
            if (!json.success) return;
            products = json.data;
        }

        function openModal() { renderProductList(); productModal.style.display = "flex"; }
        function closeModal() { productModal.style.display = "none"; }

        function renderProductList() {
            productList.innerHTML = "";
            products.forEach(p => {
                productList.innerHTML += `
<div class="modal-item"
onclick="addItem(${p.id},'${p.metadata.name.replace(/'/g, "")}')">
<b>${p.metadata.name}</b><br>
${p.metadata.desc || ""}
</div>`;
            });
        }

        function addItem(id, name) {
            let existed = false;
            document.querySelectorAll("#bodyTable tr").forEach(r => {
                if (parseInt(r.cells[0].innerText) === id) existed = true;
            });
            if (existed) return alert("Sản phẩm đã tồn tại!");

            bodyTable.insertAdjacentHTML("beforeend", `
<tr>
<td>${id}</td>
<td>${name}</td>
<td><input type="number" value="1" min="1"></td>
<td><button class="remove-btn" onclick="this.closest('tr').remove()">X</button></td>
</tr>`);
            closeModal();
        }

        async function submitTransfer() {
            if (warehouseFrom.value === warehouseTo.value)
                return alert("Kho nguồn và kho đích không được giống nhau!");

            const rows = document.querySelectorAll("#bodyTable tr");
            if (rows.length === 0) return alert("Chưa có sản phẩm");

            const items = [];
            rows.forEach(r => {
                items.push({
                    def_id: parseInt(r.cells[0].innerText),
                    quantity: parseInt(r.cells[2].querySelector("input").value)
                });
            });

            const payload = {
                items: items,
                desc: desc.value,
                warehouse_from_id: parseInt(warehouseFrom.value),
                warehouse_to_id: parseInt(warehouseTo.value),
                type_int: 3
            };

            const res = await fetch(BASE + "/create-transfer", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify(payload)
            });
            const json = await res.json();
            if (!json.success) return alert("Thất bại");

            alert("Tạo đơn chuyển thành công!");
            location.reload();
        }

        loadWarehouses();
        loadProducts();
    </script>
</body>
</html>