<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Admin | User Management</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="layout">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <h2 class="logo">ECWMS</h2>
        <ul>
            <li class="active">User Management</li>
            <li>System Configuration</li>
            <li id="logoutBtn" style="cursor:pointer;">Logout</li>
        </ul>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="content">

        <!-- HEADER -->
        <div class="header">
            <h1>User Management</h1>
            <button class="btn-primary">+ Add User</button>
        </div>

        <!-- FILTER BAR -->
        <div class="filter-bar">
            <input type="text" id="searchInput" placeholder="Search by ID or username">
            <button class="btn-secondary" id="searchBtn">Search</button>
        </div>

        <!-- TABLE -->
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>User</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                <!-- DATA WILL LOAD HERE -->
            </tbody>
        </table>

        <!-- PAGINATION (Optional future use) -->
        <div class="pagination">
            <button>&lt;</button>
            <button class="active">1</button>
            <button>&gt;</button>
        </div>

    </main>
</div>

<script>
const BASE_URL = "https://localhost:7297/api";

// ================= API REQUEST FUNCTION =================
async function apiRequest(endpoint, method = "GET", body = null) {
    const options = {
        method: method,
        headers: {
            "Content-Type": "application/json"
        },
        credentials: "include" // IMPORTANT for Cookie Auth
    };

    if (body) {
        options.body = JSON.stringify(body);
    }

    const response = await fetch(`${BASE_URL}${endpoint}`, options);

    if (response.status === 401) {
        alert("Session expired. Please login again.");
        window.location.href = "/login.html";
        return;
    }

    return await response.json();
}

// ================= LOAD USERS =================
async function loadUsers() {
    try {
        const result = await apiRequest("/admin/users");

        if (result.success) {
            renderUsers(result.data);
        } else {
            alert("Failed to load users");
        }
    } catch (err) {
        console.error(err);
    }
}

// ================= RENDER USERS =================
function renderUsers(users) {
    const tbody = document.getElementById("userTableBody");
    tbody.innerHTML = "";

    if (!users || users.length === 0) {
        tbody.innerHTML = "<tr><td colspan='6'>No users found</td></tr>";
        return;
    }

    users.forEach(user => {

        const role = user.roles
            ? user.roles.map(r => r.roleName).join(", ")
            : "";

        const statusClass =
            user.status === "Active" ? "active" :
            user.status === "Disabled" ? "disabled" :
            "locked";

        const row = `
            <tr>
                <td>${user.userId}</td>
                <td>${user.username}</td>
                <td>${role}</td>
                <td><span class="status ${statusClass}">${user.status}</span></td>
                <td>
                    <button class="btn-link danger" onclick="deleteUser('${user.userId}')">
                        Delete
                    </button>
                </td>
            </tr>
        `;

        tbody.innerHTML += row;
    });
}

// ================= DELETE USER =================
async function deleteUser(id) {
    if (!confirm("Are you sure you want to delete this user?")) return;

    try {
        const result = await apiRequest(`/admin/delete-account/${id}`, "DELETE");

        if (result.success) {
            alert("Deleted successfully");
            loadUsers();
        } else {
            alert(result.message || "Delete failed");
        }
    } catch (err) {
        console.error(err);
    }
}

// ================= SEARCH USERS =================
async function searchUsers() {
    const query = document.getElementById("searchInput").value;

    try {
        const result = await apiRequest(`/admin/search-users?query=${query}`);

        if (result.success) {
            renderUsers(result.data);
        } else {
            alert("Search failed");
        }
    } catch (err) {
        console.error(err);
    }
}

// ================= LOGOUT =================
async function logout() {
    await apiRequest("/auth/logout", "POST");
    window.location.href = "/login.html";
}

// ================= EVENTS =================
document.getElementById("searchBtn").addEventListener("click", searchUsers);
document.getElementById("logoutBtn").addEventListener("click", logout);
document.addEventListener("DOMContentLoaded", loadUsers);

</script>

</body>
</html>
