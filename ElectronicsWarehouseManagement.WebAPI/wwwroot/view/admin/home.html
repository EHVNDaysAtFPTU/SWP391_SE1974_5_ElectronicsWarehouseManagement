<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Admin | User Management</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="layout">
        <div class="sidebar">
            <h2>ECWMS</h2>
            <p onclick="logout()">Logout</p>
        </div>

        <div class="content">

            <h2>User Management</h2>
            <button class="btn-primary" onclick="openModal()">+ Add User</button>

            <br><br>

            <input id="searchInput" placeholder="Search username or email">
            <button onclick="searchUsers()">Search</button>

            <br><br>

            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="userTableBody"></tbody>
            </table>

        </div>
    </div>

    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <h3>Create User</h3>
            <input id="newUsername" placeholder="Username"><br><br>
            <input id="newEmail" placeholder="Email"><br><br>
            <input id="newPassword" type="password" placeholder="Password"><br><br>
            <select id="newRole">
                <option value="2">Manager</option>
                <option value="3">Storekeeper</option>
            </select><br><br>
            <button class="btn-primary" onclick="createUser()">Create</button>
            <button onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <script>
        const BASE = "https://localhost:7297/api";

        async function api(endpoint, method = "GET", body = null) {
            const opt = {
                method,
                headers: { "Content-Type": "application/json" },
                credentials: "include"
            };
            if (body) opt.body = JSON.stringify(body);
            const res = await fetch(BASE + endpoint, opt);
            return await res.json();
        }

        async function loadUsers() {
            const r = await api("/admin/users");
            if (r.success) {
                render(r.data);
            } else {
                alert("Load failed");
            }
        }

        function render(users) {
            const tbody = document.getElementById("userTableBody");
            tbody.innerHTML = "";

            users.forEach(u => {

                let statusText = "";
                switch (u.status) {
                    case 1: statusText = "Active"; break;
                    case 2: statusText = "Locked"; break;
                    case 3: statusText = "Disabled"; break;
                    case 4: statusText = "Deleted"; break;
                    default: statusText = u.status;
                }

                tbody.innerHTML += `
<tr>
<td>${u.user_id}</td>
<td>${u.username}</td>
<td>${u.email}</td>
<td>${statusText}</td>
<td>
<button class="btn-danger" onclick="deleteUser(${u.user_id})">
Delete
</button>
</td>
</tr>`;
            });
        }

        async function createUser() {

            const username = document.getElementById("newUsername").value;
            const email = document.getElementById("newEmail").value;
            const password = document.getElementById("newPassword").value;
            const roleId = parseInt(document.getElementById("newRole").value);

            const response = await fetch(BASE + "/admin/create-account", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify({
                    username,
                    email,
                    password,
                    role_id: roleId
                })
            });

            const data = await response.json();

            if (response.ok) {
                alert("Create success");
                closeModal();
                loadUsers();
            } else {
                alert(data.message || "Create failed");
            }
        }

        async function deleteUser(id) {
            if (!confirm("Delete?")) return;
            const r = await api(`/admin/delete-account/${id}`, "DELETE");
            if (r.success) loadUsers();
        }

        async function searchUsers() {
            const q = document.getElementById("searchInput").value.trim();
            if (!q) { loadUsers(); return; }
            const r = await api(`/admin/search-users?query=${q}`);
            if (r.success) render(r.data);
        }

        function openModal() {
            document.getElementById("modal").classList.remove("hidden");
        }

        function closeModal() {
            document.getElementById("modal").classList.add("hidden");
        }

        async function logout() {
            await api("/auth/logout", "POST");
            location.href = "/login.html";
        }

        document.addEventListener("DOMContentLoaded", loadUsers);
    </script>

</body>
</html>