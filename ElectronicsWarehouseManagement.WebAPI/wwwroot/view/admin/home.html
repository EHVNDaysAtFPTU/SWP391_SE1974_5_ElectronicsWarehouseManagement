<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Admin | User Management</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="layout">

        <!-- SIDEBAR -->
        <aside class="sidebar">
            <h2 class="logo">ECWMS</h2>
            <ul>
                <li class="active">User Management</li>
                <li>System Configuration</li>
                <li id="logoutBtn" style="cursor:pointer;">Logout</li>
            </ul>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="content">

            <div class="header">
                <h1>User Management</h1>
                <button class="btn-primary">+ Add User</button>
            </div>

            <div class="filter-bar">
                <input type="text" id="searchInput" placeholder="Search by ID or username">
                <button class="btn-secondary" id="searchBtn">Search</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="userTableBody"></tbody>
            </table>

        </main>
    </div>

    <script>
        const BASE_URL = "https://localhost:7297/api";

        // ================= API =================
        async function apiRequest(endpoint, method = "GET", body = null) {

            const options = {
                method,
                headers: { "Content-Type": "application/json" },
                credentials: "include"
            };

            if (body) options.body = JSON.stringify(body);

            const response = await fetch(`${BASE_URL}${endpoint}`, options);

            if (response.status === 401) {
                alert("Session expired. Please login again.");
                window.location.href = "/login.html";
                return;
            }

            return await response.json();
        }

        // ================= LOAD USERS =================
        async function loadUsers() {
            const result = await apiRequest("/admin/users");

            if (result?.success) {
                renderUsers(result.data);
            }
        }

        // ================= RENDER USERS =================
        function renderUsers(users) {

            const tbody = document.getElementById("userTableBody");
            tbody.innerHTML = "";

            if (!users || users.length === 0) {
                tbody.innerHTML = "<tr><td colspan='5'>No users found</td></tr>";
                return;
            }

            users.forEach(user => {

                const roleText = user.roles?.map(r => r.roleName).join(", ") ?? "";

                const statusClass =
                    user.status === "Active" ? "active" :
                        user.status === "Disabled" ? "disabled" :
                            "locked";

                const tr = document.createElement("tr");

                tr.innerHTML = `
                <td>${user.userId}</td>
                <td>${user.username}</td>
                <td>${roleText}</td>
                <td><span class="status ${statusClass}">${user.status}</span></td>
                <td>
                    <button onclick="viewUser('${user.userId}')">View</button>
                    <button onclick="editUser('${user.userId}','${user.username}','${user.status}')">Edit</button>
                    <button class="danger" onclick="deleteUser('${user.userId}')">Delete</button>
                </td>
            `;

                tbody.appendChild(tr);
            });
        }

        // ================= VIEW =================
        function viewUser(id) {

            const row = [...document.querySelectorAll("#userTableBody tr")]
                .find(r => r.children[0].innerText == id);

            document.getElementById("viewId").innerText = row.children[0].innerText;
            document.getElementById("viewUsername").innerText = row.children[1].innerText;
            document.getElementById("viewRoles").innerText = row.children[2].innerText;
            document.getElementById("viewStatus").innerText = row.children[3].innerText;

            openModal("viewModal");
        }

        // ================= EDIT =================
        function editUser(id, username, status) {

            document.getElementById("editUserId").value = id;
            document.getElementById("editUsername").value = username;
            document.getElementById("editStatus").value = status;

            openModal("editModal");
        }

        async function updateUser() {

            const id = document.getElementById("editUserId").value;

            const body = {
                username: document.getElementById("editUsername").value,
                status: document.getElementById("editStatus").value
            };

            const result = await apiRequest(`/admin/update-user/${id}`, "PUT", body);

            if (result?.success) {
                alert("Updated successfully");
                closeModal("editModal");
                loadUsers();
            } else {
                alert(result?.message || "Update failed");
            }
        }

        // ================= DELETE =================
        async function deleteUser(id) {

            if (!confirm("Are you sure?")) return;

            const result = await apiRequest(`/admin/delete-account/${id}`, "DELETE");

            if (result?.success) {
                loadUsers();
            }
        }

        // ================= SEARCH =================
        async function searchUsers() {

            const query = document.getElementById("searchInput").value;

            const result = await apiRequest(`/admin/search-users?query=${query}`);

            if (result?.success) {
                renderUsers(result.data);
            }
        }

        // ================= MODAL =================
        function openModal(id) {
            document.getElementById(id).style.display = "flex";
        }

        function closeModal(id) {
            document.getElementById(id).style.display = "none";
        }

        // ================= LOGOUT =================
        async function logout() {
            await apiRequest("/auth/logout", "POST");
            window.location.href = "/login.html";
        }

        // ================= EVENTS =================
        document.getElementById("searchBtn").addEventListener("click", searchUsers);
        document.getElementById("logoutBtn").addEventListener("click", logout);
        document.addEventListener("DOMContentLoaded", loadUsers);

    </script>

</body>
</html>