<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Item List - Electronic Components Warehouse</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #f8f9fa;
        }

        .sidebar {
            min-height: 100vh;
        }

        .bin-detail {
            font-size: 13px;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">

        <!-- Sidebar -->
        <nav class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse">
            <div class="position-sticky pt-3 text-white p-3">
                <h5 class="text-center mb-4">Manager Panel</h5>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link text-white" href="home.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white active" href="itemlist.html">View Items</a>
                    </li>
                    <li class="nav-item"><a class="nav-link text-white" href="#">Transfer Requests</a></li>
                    <li class="nav-item"><a class="nav-link text-white" href="#">Receipts</a></li>
                    <li class="nav-item"><a class="nav-link text-white" href="#">Approve GR</a></li>
                    <li class="nav-item"><a class="nav-link text-white" href="#">Reports</a></li>
                    <li class="nav-item"><a class="nav-link text-white" href="#">Export Report</a></li>
                </ul>
            </div>
        </nav>

        <!-- Main content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">

            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">Items Inventory</h2>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>

            <div id="messageContainer"></div>

            <!-- Controls -->
            <div class="card shadow-sm mb-4">
                <div class="card-body d-flex align-items-center gap-3 flex-wrap">
                    <label class="fw-semibold">Items per page:</label>
                    <select id="pageSize" class="form-select w-auto" onchange="changePageSize()">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                    <div id="infoText" class="text-muted ms-auto"></div>
                </div>
            </div>

            <!-- Table -->
            <div class="card shadow-sm">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Item ID</th>
                                <th>Item Name</th>
                                <th>Quantity</th>
                                <th>Import Date</th>
                                <th>Transfer</th>
                                <th>Inbound</th>
                                <th>Outbound</th>
                                <th>Bins</th>
                            </tr>
                        </thead>
                        <tbody id="itemsBody">
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <div class="spinner-border text-primary"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            <nav class="mt-4">
                <ul class="pagination justify-content-center" id="paginationContainer"></ul>
            </nav>

            <footer class="text-center text-muted mt-5">
                © 2026 Electronic Components Warehouse Management System
            </footer>

        </main>
    </div>
</div>

<script>
let currentPage = 1;
let pageSize = 10;
let totalPages = 1;
let itemDetailCache = {};

document.addEventListener('DOMContentLoaded', function () {
    loadItems(1);
});

async function loadItems(page) {
    try {
        currentPage = page;

        const response = await fetch(`/api/manager/get-items?pageNumber=${page}&pageSize=${pageSize}`, {
            method: 'GET',
            credentials: 'include'
        });

        const result = await response.json();

        if (result.success) {
            displayItems(result.data);
            totalPages = result.data.totalPages;
            updatePagination();
        } else {
            showMessage(result.message || 'Failed to load items', 'danger');
        }

    } catch (error) {
        showMessage(error.message, 'danger');
    }
}

function displayItems(data) {
    const tbody = document.getElementById('itemsBody');
    const infoText = document.getElementById('infoText');

    if (!data.data || data.data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center py-4">No items found</td></tr>`;
        return;
    }

    infoText.textContent =
        `Showing ${(currentPage - 1) * pageSize + 1}
         to ${Math.min(currentPage * pageSize, data.totalCount)}
         of ${data.totalCount} items`;

    tbody.innerHTML = data.data.map(item => `
        <tr>
            <td>${item.id}</td>
            <td>${item.definition?.metadata?.name || 'N/A'}</td>
            <td><span class="badge bg-primary">${item.quantity}</span></td>
            <td>${formatDate(item.import_date)}</td>
            <td>-</td>
            <td>-</td>
            <td>-</td>
            <td>
                <button class="btn btn-sm btn-outline-primary"
                        onclick="toggleBinDetail(${item.id})"
                        id="btn-${item.id}">
                    View
                </button>
                <div id="bin-detail-${item.id}" class="bin-detail mt-2 text-muted"></div>
            </td>
        </tr>
    `).join('');
}

async function toggleBinDetail(itemId) {
    const detailDiv = document.getElementById(`bin-detail-${itemId}`);
    const button = document.getElementById(`btn-${itemId}`);

    if (detailDiv.innerHTML !== "") {
        detailDiv.innerHTML = "";
        button.textContent = "View";
        return;
    }

    if (itemDetailCache[itemId]) {
        detailDiv.innerHTML = itemDetailCache[itemId];
        button.textContent = "Hide";
        return;
    }

    button.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;

    const response = await fetch(`/api/manager/get-item/${itemId}?fullInfo=true`, {
        credentials: 'include'
    });

    const result = await response.json();

    const item = result.data;
    let html = "";

    if (item.bins && item.bins.length > 0) {
        html = item.bins.map(b => `• ${b.location_in_warehouse}`).join("<br>");
    } else {
        html = "No bins";
    }

    itemDetailCache[itemId] = html;
    detailDiv.innerHTML = html;
    button.textContent = "Hide";
}

function updatePagination() {
    const container = document.getElementById('paginationContainer');
    container.innerHTML = '';

    for (let i = 1; i <= totalPages; i++) {
        container.innerHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadItems(${i})">${i}</a>
            </li>
        `;
    }
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('en-US');
}

function showMessage(message, type) {
    document.getElementById('messageContainer').innerHTML =
        `<div class="alert alert-${type}">${message}</div>`;
}

function changePageSize() {
    pageSize = parseInt(document.getElementById('pageSize').value);
    loadItems(1);
}

function logout() {
    window.location.href = '/login';
}
</script>

</body>
</html>